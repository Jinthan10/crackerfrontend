# -------------------------------------------------------------
# Azure DevOps Pipeline for React Frontend Deployment
# Source: GitHub (Jinthan10/crackerfrontend)
# Target: Azure Storage Account (myblobui)
# Agent: Windows (testing)
# Service connection: mypip
# ACR: backendapli
# -------------------------------------------------------------

trigger:
- main   # change if your default GitHub branch is 'master' or something else

# ----------------------------------------
# Connect GitHub repo properly
# ----------------------------------------
resources:
  repositories:
  - repository: self
    type: github
    name: Jinthan10/crackerfrontend   # üëà your GitHub repo name
    endpoint: github-connection        # üëà your GitHub service connection (create it once)

# ----------------------------------------
# Use your self-hosted Windows agent
# ----------------------------------------
pool:
  name: 'Default'
  demands:
  - agent.name -equals testing

# ----------------------------------------
# Variables
# ----------------------------------------
variables:
  azureSubscription: 'mypip'          # ‚úÖ your Azure service connection
  storageAccountName: 'myblobui'      # ‚úÖ your Storage Account name
  acrName: 'backendapli'              # ‚úÖ your ACR name
  buildDir: 'build'                   # React build output folder
  artifactName: 'drop'                # temporary artifact name

# ==============================================================
# Stage 1: BUILD FRONTEND
# ==============================================================
stages:
- stage: Build
  displayName: 'Build React Frontend'
  jobs:
  - job: BuildReact
    displayName: 'Install and Build React App'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
      displayName: 'Install Node.js 18'

    - checkout: self
      displayName: 'Checkout Source Code from GitHub'

    - script: |
        echo "üì¶ Installing npm dependencies..."
        npm install
        echo "üèóÔ∏è Building React app..."
        npm run build
      displayName: 'Build React Project'

    - task: PublishBuildArtifacts@1
      inputs:
        pathToPublish: '$(buildDir)'
        artifactName: '$(artifactName)'
      displayName: 'Publish Build Artifacts'

# ==============================================================
# Stage 2: DEPLOY TO AZURE STORAGE
# ==============================================================
- stage: Deploy
  displayName: 'Deploy React App to Azure Storage'
  dependsOn: Build
  jobs:
  - deployment: DeployToStorage
    displayName: 'Upload React Build to Storage Account'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: $(artifactName)
            displayName: 'Download Build Artifact'

          - task: AzureCLI@2
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "üîê Logging into Azure Container Registry..."
                az acr login --name $(acrName)

                echo "üöÄ Uploading React build files to Azure Storage..."
                az storage blob upload-batch `
                  --account-name $(storageAccountName) `
                  -s "$(Pipeline.Workspace)/$(artifactName)" `
                  -d '$web' `
                  --overwrite

                echo "‚úÖ Deployment completed successfully!"
            displayName: 'Upload Build to $web container'
