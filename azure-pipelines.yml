trigger:
  - main   # change if your branch is different

variables:
  # ---- Sonar ----
  SONARQUBE_IMAGE: 'sonarqube:lts'
  SONAR_SCANNER_IMAGE: 'sonarsource/sonar-scanner-cli:latest'
  SONAR_PROJECT_KEY: 'backendapli'
  SONAR_PROJECT_NAME: 'Backend Application'
  SONAR_PROJECT_VERSION: '1.0'

  # ---- Azure ----
  azureSubscription: 'Azure-Connection'
  azureResourceGroup: 'my-rg'
  acrName: 'backendapli'
  acrServer: 'backendapli.azurecr.io'
  containerGroup: 'backendapli'
  imageName: 'backendapli'

pool:
  vmImage: 'ubuntu-latest'

steps:
# -----------------------------
# STEP 1: Checkout code
# -----------------------------
- checkout: self

# -----------------------------
# STEP 2: Run SonarQube (Docker)
# -----------------------------
- script: |
    echo "Pull and run SonarQube container..."
    docker run -d --name sonarqube -p 9000:9000 $(SONARQUBE_IMAGE)
    echo "Waiting for SonarQube to be ready..."
    sudo apt-get update -y && sudo apt-get install -y jq curl
    for i in {1..60}; do
      status=$(curl -s http://localhost:9000/api/system/status | jq -r .status 2>/dev/null)
      if [ "$status" = "UP" ]; then
        echo "SonarQube is UP!"
        break
      fi
      echo "Still starting... ($i/60)"
      sleep 5
    done
  displayName: 'Run local SonarQube container'

# -----------------------------
# STEP 3: Run Sonar Scanner (Docker)
# -----------------------------
- script: |
    echo "Running Sonar Scanner..."
    docker run --rm \
      --add-host=host.docker.internal:host-gateway \
      -e SONAR_HOST_URL="http://host.docker.internal:9000" \
      -e SONAR_TOKEN="admin" \
      -v "$(System.DefaultWorkingDirectory):/usr/src" \
      $(SONAR_SCANNER_IMAGE) \
      -Dsonar.projectKey="$(SONAR_PROJECT_KEY)" \
      -Dsonar.projectName="$(SONAR_PROJECT_NAME)" \
      -Dsonar.projectVersion="$(SONAR_PROJECT_VERSION)" \
      -Dsonar.sources=/usr/src
  displayName: 'Run SonarQube Scanner'

# -----------------------------
# STEP 4: Stop SonarQube container
# -----------------------------
- script: |
    echo "Cleaning up SonarQube container..."
    docker stop sonarqube || true
    docker rm sonarqube || true
  displayName: 'Stop SonarQube container'

# -----------------------------
# STEP 5: Build + Push Docker image to ACR
# -----------------------------
- task: Docker@2
  displayName: 'Build and push Docker image to ACR'
  inputs:
    containerRegistry: '$(azureSubscription)'
    repository: '$(imageName)'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'
    tags: |
      $(Build.BuildId)

# -----------------------------
# STEP 6: Deploy to Azure Container Instance
# -----------------------------
- task: AzureCLI@2
  displayName: 'Deploy to Azure Container Instance'
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      echo "Deploying new image to ACI..."
      az container create \
        --resource-group $(azureResourceGroup) \
        --name $(containerGroup) \
        --image $(acrServer)/$(imageName):$(Build.BuildId) \
        --registry-login-server $(acrServer) \
        --dns-name-label $(containerGroup)-$RANDOM \
        --ports 8080
